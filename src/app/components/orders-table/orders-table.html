@if (loading()) {
  <div>Lade Aufträge...</div>
}

@if (error()) {
  <div>{{ error() }}</div>
}

@if (!loading() && !error()) {
  <div style="display: flex; gap: 16px; align-items: center; margin-bottom: 16px;">
    <!-- Reactive Form Filter -->
    <mat-form-field appearance="fill" style="flex: 1;">
      <mat-label>Suche</mat-label>
      <input matInput [formControl]="searchControl" placeholder="ID, Quelle, Ziel, Fahrzeug">
      <mat-icon matSuffix>search</mat-icon>
    </mat-form-field>

    <!-- Spaltenauswahl Button -->
    <button mat-raised-button [matMenuTriggerFor]="columnsMenu">
      <mat-icon>view_column</mat-icon>
      Spalten
    </button>
  </div>

  <!-- Spaltenauswahl Menu -->
  <mat-menu #columnsMenu="matMenu">
    @for (column of allColumns; track column.id) {
      <div mat-menu-item (click)="$event.stopPropagation()">
        <mat-checkbox
          [checked]="column.visible"
          (change)="toggleColumn(column.id)">
          {{ column.label }}
        </mat-checkbox>
      </div>
    }
  </mat-menu>

  <table mat-table [dataSource]="dataSource" matSort class="mat-elevation-z8" multiTemplateDataRows>

    <!-- ID Column -->
    <ng-container matColumnDef="id">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>ID</th>
      <td mat-cell *matCellDef="let order">{{ order.id }}</td>
    </ng-container>

    <!-- Status Column -->
    <ng-container matColumnDef="status">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Status</th>
      <td mat-cell *matCellDef="let order">
        <mat-chip [class]="getStatusColor(order.status)" selected>{{ order.status }}</mat-chip>
      </td>
    </ng-container>

    <!-- Priority Column -->
    <ng-container matColumnDef="priority">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Priorität</th>
      <td mat-cell *matCellDef="let order">{{ order.priority }}</td>
    </ng-container>

    <!-- Source Column -->
    <ng-container matColumnDef="source">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Quelle</th>
      <td mat-cell *matCellDef="let order">{{ order.source }}</td>
    </ng-container>

    <!-- Target Column -->
    <ng-container matColumnDef="target">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Ziel</th>
      <td mat-cell *matCellDef="let order">{{ order.target }}</td>
    </ng-container>

    <!-- Vehicle Column -->
    <ng-container matColumnDef="vehicleId">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Fahrzeug</th>
      <td mat-cell *matCellDef="let order">{{ order.vehicleId || '-' }}</td>
    </ng-container>

    <!-- CreatedAt Column -->
    <ng-container matColumnDef="createdAt">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Erstellt am</th>
      <td mat-cell *matCellDef="let order">{{ order.createdAt | date:'dd.MM.yyyy HH:mm' }}</td>
    </ng-container>

    <!-- ETA Column -->
    <ng-container matColumnDef="eta">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>ETA</th>
      <td mat-cell *matCellDef="let order">{{ order.eta | date:'dd.MM.yyyy HH:mm' }}</td>
    </ng-container>

    <!-- Duration Column -->
    <ng-container matColumnDef="duration">
      <th mat-header-cell *matHeaderCellDef>Dauer (min)</th>
      <td mat-cell *matCellDef="let order">{{ getDuration(order) | number:'1.0-0' }}</td>
    </ng-container>

    <!-- Detailansicht Column (erweiterte Zeile) -->
    <ng-container matColumnDef="expandedDetail">
      <td mat-cell *matCellDef="let order" [attr.colspan]="displayedColumns.length">
        <div class="order-detail-row" [@detailExpand]="order === selectedOrder() ? 'expanded' : 'collapsed'">
          <div class="order-details">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
              <h3>Auftragsdetails: {{ order.id }}</h3>
              <button (click)="closeDetails(); $event.stopPropagation()" mat-raised-button color="warn">Schließen</button>
            </div>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
              <div><strong>Status:</strong> {{ order.status }}</div>
              <div><strong>Priorität:</strong> {{ order.priority }}</div>
              <div><strong>Quelle:</strong> {{ order.source }}</div>
              <div><strong>Ziel:</strong> {{ order.target }}</div>
              <div><strong>Fahrzeug:</strong> {{ order.vehicleId || 'Nicht zugewiesen' }}</div>
              <div><strong>Erstellt am:</strong> {{ order.createdAt | date:'dd.MM.yyyy HH:mm' }}</div>
              @if (order.eta) {
                <div><strong>ETA:</strong> {{ order.eta | date:'dd.MM.yyyy HH:mm' }}</div>
              }
              @if (getDuration(order)) {
                <div><strong>Dauer:</strong> {{ getDuration(order) | number:'1.0-0' }} Minuten</div>
              }
            </div>
          </div>
        </div>
      </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
    <tr mat-row *matRowDef="let row; columns: displayedColumns;"
        (click)="selectOrder(row)"
        [class.selected-row]="row === selectedOrder()"
        style="cursor: pointer;"></tr>
    <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="detail-row"></tr>
  </table>

  <mat-paginator [pageSizeOptions]="[25, 50, 100]" showFirstLastButtons></mat-paginator>
}
