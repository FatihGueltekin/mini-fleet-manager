@if (loading()) {
  <div class="text-center py-8 text-gray-600">Lade Aufträge...</div>
}

@if (error()) {
  <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">{{ error() }}</div>
}

@if (!loading() && !error()) {
  <div class="flex gap-4 items-center mb-4">
    <!-- Reactive Form Filter -->
    <mat-form-field appearance="fill" class="flex-1">
      <mat-label>Suche</mat-label>
      <input matInput [formControl]="searchControl" placeholder="ID, Quelle, Ziel, Fahrzeug">
      <mat-icon matSuffix>search</mat-icon>
    </mat-form-field>

    <!-- Spaltenauswahl Button -->
    <button mat-raised-button [matMenuTriggerFor]="columnsMenu">
      <mat-icon>view_column</mat-icon>
      Spalten
    </button>
  </div>

  <!-- Spaltenauswahl Menu -->
  <mat-menu #columnsMenu="matMenu">
    @for (column of allColumns; track column.id) {
      <div mat-menu-item (click)="$event.stopPropagation()">
        <mat-checkbox
          [checked]="column.visible"
          (change)="toggleColumn(column.id)">
          {{ column.label }}
        </mat-checkbox>
      </div>
    }
  </mat-menu>

  <table mat-table [dataSource]="dataSource" matSort class="mat-elevation-z8" multiTemplateDataRows>

    <!-- ID Column -->
    <ng-container matColumnDef="id">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>ID</th>
      <td mat-cell *matCellDef="let order">{{ order.id }}</td>
    </ng-container>

    <!-- Status Column -->
    <ng-container matColumnDef="status">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Status</th>
      <td mat-cell *matCellDef="let order">
        <mat-chip [class]="getStatusColor(order.status)" selected>{{ order.status }}</mat-chip>
      </td>
    </ng-container>

    <!-- Priority Column -->
    <ng-container matColumnDef="priority">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Priorität</th>
      <td mat-cell *matCellDef="let order">{{ order.priority }}</td>
    </ng-container>

    <!-- Source Column -->
    <ng-container matColumnDef="source">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Quelle</th>
      <td mat-cell *matCellDef="let order">{{ order.source }}</td>
    </ng-container>

    <!-- Target Column -->
    <ng-container matColumnDef="target">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Ziel</th>
      <td mat-cell *matCellDef="let order">{{ order.target }}</td>
    </ng-container>

    <!-- Vehicle Column -->
    <ng-container matColumnDef="vehicleId">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Fahrzeug</th>
      <td mat-cell *matCellDef="let order">{{ order.vehicleId || '-' }}</td>
    </ng-container>

    <!-- CreatedAt Column -->
    <ng-container matColumnDef="createdAt">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Erstellt am</th>
      <td mat-cell *matCellDef="let order">{{ order.createdAt | date:'dd.MM.yyyy HH:mm' }}</td>
    </ng-container>

    <!-- ETA Column -->
    <ng-container matColumnDef="eta">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>ETA</th>
      <td mat-cell *matCellDef="let order">{{ order.eta | date:'dd.MM.yyyy HH:mm' }}</td>
    </ng-container>

    <!-- Duration Column -->
    <ng-container matColumnDef="duration">
      <th mat-header-cell *matHeaderCellDef>Dauer (min)</th>
      <td mat-cell *matCellDef="let order">{{ getDuration(order) | number:'1.0-0' }}</td>
    </ng-container>

    <!-- Detailansicht Column (erweiterte Zeile) -->
    <ng-container matColumnDef="expandedDetail">
      <td mat-cell *matCellDef="let order" [attr.colspan]="displayedColumns.length">
        <div class="order-detail-row" [@detailExpand]="order === selectedOrder() ? 'expanded' : 'collapsed'">
          <div class="order-details mt-5 animate-slideDown">
            <div class="flex justify-between items-center mb-5">
              <h3 class="text-xl font-semibold text-indigo-700">Auftragsdetails: {{ order.id }}</h3>
              <button (click)="closeDetails(); $event.stopPropagation()" mat-raised-button color="warn">Schließen</button>
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div class="p-2 border-l-4 border-indigo-600 bg-gray-100">
                <strong class="block mb-1 text-indigo-700">Status:</strong>
                <span>{{ order.status }}</span>
              </div>
              <div class="p-2 border-l-4 border-indigo-600 bg-gray-100">
                <strong class="block mb-1 text-indigo-700">Priorität:</strong>
                <span>{{ order.priority }}</span>
              </div>
              <div class="p-2 border-l-4 border-indigo-600 bg-gray-100">
                <strong class="block mb-1 text-indigo-700">Quelle:</strong>
                <span>{{ order.source }}</span>
              </div>
              <div class="p-2 border-l-4 border-indigo-600 bg-gray-100">
                <strong class="block mb-1 text-indigo-700">Ziel:</strong>
                <span>{{ order.target }}</span>
              </div>
              <div class="p-2 border-l-4 border-indigo-600 bg-gray-100">
                <strong class="block mb-1 text-indigo-700">Fahrzeug:</strong>
                <span>{{ order.vehicleId || 'Nicht zugewiesen' }}</span>
              </div>
              <div class="p-2 border-l-4 border-indigo-600 bg-gray-100">
                <strong class="block mb-1 text-indigo-700">Erstellt am:</strong>
                <span>{{ order.createdAt | date:'dd.MM.yyyy HH:mm' }}</span>
              </div>
              @if (order.eta) {
                <div class="p-2 border-l-4 border-indigo-600 bg-gray-100">
                  <strong class="block mb-1 text-indigo-700">ETA:</strong>
                  <span>{{ order.eta | date:'dd.MM.yyyy HH:mm' }}</span>
                </div>
              }
              @if (getDuration(order)) {
                <div class="p-2 border-l-4 border-indigo-600 bg-gray-100">
                  <strong class="block mb-1 text-indigo-700">Dauer:</strong>
                  <span>{{ getDuration(order) | number:'1.0-0' }} Minuten</span>
                </div>
              }
            </div>
          </div>
        </div>
      </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
    <tr mat-row *matRowDef="let row; columns: displayedColumns;"
        (click)="selectOrder(row)"
        [class.selected-row]="row === selectedOrder()"
        class="cursor-pointer hover:bg-gray-100 transition-colors"></tr>
    <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="detail-row h-0"></tr>
  </table>

  <mat-paginator [pageSizeOptions]="[25, 50, 100]" showFirstLastButtons></mat-paginator>
}
